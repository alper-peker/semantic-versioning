name: Require PR Label & Multi-Approval

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review, labeled, unlabeled]
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # 1) SemVer label kontrolü (çokluya izin var)
  check-label:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: SemVer Label Check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name);
            const semverSet = new Set([
              "breaking change","feature",
              "fix","perf","refactor","docs","test","build","ci","deps","revert","security"
            ]);

            const found = labels.filter(l => semverSet.has(l));
            if (found.length < 1) {
              core.setFailed("At least one SemVer-impact label is required.");
              return;
            }
            core.info("SemVer labels present: " + found.join(", "));

  # 2) Onay mekanizması (sadece /approve-label yorumu geldiğinde devreye girer)
  handle-approval-command:
    if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/approve-label')
    runs-on: ubuntu-latest
    steps:
      - name: Process approval command
        uses: actions/github-script@v7
        with:
          script: |
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.issue.number;
            const user   = context.payload.comment.user.login;

            const REQUIRED_APPROVALS = 2;
            const APPROVERS = ["AlperPeker", "alper-peker"];

            if (!APPROVERS.includes(user)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `@${user} is not authorized to approve merges.`
              });
              return;
            }

            // Bu kişinin onayı kaydediliyor (geçici listeyi issue body’ye gömmek yerine labels üzerinden kontrol)
            const currentLabels = (await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            // Approval tekrarlandığında labels:approved sıfırlanır, sonra yeniden eklenir.
            if (currentLabels.includes("labels:approved")) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: number, name: "labels:approved" }).catch(()=>{});
            }

            // Yorum bırak
            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: `Approval registered from @${user}.`
            });

            // Onaylayanları topla (en son 10 yorumu çekip sayabiliriz)
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: number, per_page: 50 });
            const approvers = new Set(
              comments.data
                .filter(c => c.body?.trim().startsWith("/approve-label"))
                .map(c => c.user.login)
                .filter(u => APPROVERS.includes(u))
            );

            if (approvers.size >= REQUIRED_APPROVALS) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: number,
                labels: ["labels:approved"]
              });
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `labels:approved added — approvals: ${[...approvers].map(u=>"@"+u).join(", ")}`
              });
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `${approvers.size}/${REQUIRE
