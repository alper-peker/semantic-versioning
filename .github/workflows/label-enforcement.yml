name: Labelling

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review, labeled, unlabeled]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-label:
    runs-on: ubuntu-latest
    steps:
      - name: SemVer Label Check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("Not a pull_request event payload. Skipping.");
              return;
            }
            const names = (pr.labels || []).map(l => l.name);

            // Bu liste ekran görüntündeki set'e göre düzenlendi
            const semverLabels = [
              "breaking change", // MAJOR
              "feature",         // MINOR
              "fix","perf","refactor","docs","test","build","ci","deps","revert","security" // PATCH
            ];

            const found = names.filter(name => semverLabels.includes(name));

            if (found.length === 0) {
              core.setFailed(
                "A SemVer label is required for pull requests. " +
                "Please add one of the labels below to continue:\n" +
                semverLabels.join(", ")
              );
            } else {
              core.info(`PR SemVer Label(s): ${found.join(", ")}`);
            }


  multi-label-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Multi-approver label approval
        uses: actions/github-script@v7
        with:
          script: |
            if (!(context.eventName === "issue_comment" && context.payload.issue?.pull_request)) {
              core.info("Not an issue_comment on a PR. Skipping.");
              return;
            }

            const owner   = context.repo.owner;
            const repo    = context.repo.repo;
            const number  = context.payload.issue.number;
            const comment = context.payload.comment;
            const body    = (comment?.body || "").trim();
            if (!body) return;

            const REQUIRED_APPROVALS = 2;
            const APPROVERS = ["AlperPeker", "alper-peker"]; // sadece bu kullanıcılar onay verebilir
            const VERSION_SET = new Set([
              "breaking change","feature",
              "fix","perf","refactor","build","ci","deps","docs","revert","security","test"
            ]);

            if (!body.startsWith("/approve-label")) {
              core.info("No /approve-label command. Skipping.");
              return;
            }

            const user = comment.user.login;
            if (!APPROVERS.includes(user)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `@${user} is not authorized to approve labels.`
              });
              return;
            }

            const currentLabels = (await github.rest.issues
              .listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            const versionLabels = currentLabels.filter(l => VERSION_SET.has(l));
            if (versionLabels.length !== 1) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: "Cannot approve: PR must have exactly one version-impact label."
              });
              return;
            }
            const versionLabel = versionLabels[0];

            const approvedTag = `approved-by:${user}`;

            if (!currentLabels.includes(approvedTag)) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: number, labels: [approvedTag]
              });
            }

            const updatedLabels = (await github.rest.issues
              .listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            const approvedBy = updatedLabels
              .filter(l => l.startsWith("approved-by:"))
              .map(l => l.replace("approved-by:", ""));

            const uniqueApprovers = Array.from(new Set(approvedBy));

            if (uniqueApprovers.length >= REQUIRED_APPROVALS) {
              if (!updatedLabels.includes("labels:approved")) {
                await github.rest.issues.addLabels({
                  owner, repo, issue_number: number, labels: ["labels:approved"]
                });
                await github.rest.issues.createComment({
                  owner, repo, issue_number: number,
                  body: `Label "${versionLabel}" approved by ${uniqueApprovers.map(u => "@" + u).join(", ")}`
                });
              }
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `${uniqueApprovers.length}/${REQUIRED_APPROVALS} approvals received for "${versionLabel}".`
              });
            }
