name: Require PR Label & Multi-Approval

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review, labeled, unlabeled]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-label:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: SemVer Label Check (allow multiple)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const names = (pr.labels || []).map(l => l.name);

            // Senin setine göre SemVer etkili label'lar
            const semverLabels = new Set([
              "breaking change","feature",           // MAJOR/MINOR
              "fix","perf","refactor","docs","test","build","ci","deps","revert","security" // PATCH
            ]);

            const found = names.filter(n => semverLabels.has(n));

            if (found.length < 1) {
              core.setFailed(
                "At least one SemVer-impact label is required. " +
                "Allowed: breaking change, feature, fix, perf, refactor, docs, test, build, ci, deps, revert, security"
              );
              return;
            }

            core.info("SemVer labels present: " + found.join(", "));
            // Not: birden çok olmasına izin var; burada fail etmiyoruz.

  multi-label-approval:
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve-label')
    runs-on: ubuntu-latest
    steps:
      - name: Multi-approver label approval
        uses: actions/github-script@v7
        with:
          script: |
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const number = context.payload.issue.number;
            const user   = context.payload.comment.user.login;

            const REQUIRED_APPROVALS = 2;
            const APPROVERS = ["AlperPeker", "alper-peker"];

            if (!APPROVERS.includes(user)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `@${user} is not authorized to approve labels.`
              });
              return;
            }

            // Bu kullanıcının approval etiketi
            const approvedTag = `approved-by:${user}`;

            // Mevcut label'ları çek
            const currentLabels = (await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            // Aynı kullanıcı tekrar onaylamışsa yeni etiket eklemeye gerek yok
            if (!currentLabels.includes(approvedTag)) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: [approvedTag] });
            }

            // Güncel onay sayısını hesapla
            const updated = (await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            const uniqueApprovers = Array.from(
              new Set(
                updated.filter(n => n.startsWith("approved-by:")).map(n => n.replace("approved-by:", ""))
              )
            );

            if (uniqueApprovers.length >= REQUIRED_APPROVALS) {
              if (!updated.includes("labels:approved")) {
                await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ["labels:approved"] });
                await github.rest.issues.createComment({
                  owner, repo, issue_number: number,
                  body: `Merge approval granted by ${uniqueApprovers.map(u => "@" + u).join(", ")}`
                });
              }
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `${uniqueApprovers.length}/${REQUIRED_APPROVALS} approvals recorded.`
              });
            }

  approval-guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Require labels:approved before merge
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name);
            if (!labels.includes("labels:approved")) {
              core.setFailed("labels:approved is required to merge this PR.");
            } else {
              core.info("labels:approved present.");
            }
