name: Approval Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write

env:
  APPROVAL_USERS: 'AlperPeker, alper-peker'
  REQUIRED_APPROVALS: '2'

jobs:
  handle-approval:
    if: startsWith(github.event.comment.body, '/approve-label') && github.event.issue.pull_request
    runs-on: ubuntu-latest
    steps:
      - name: Process /approve-label
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.issue.number;
            const user   = context.payload.comment.user.login;

            const APPROVERS = process.env.APPROVAL_USERS.split(",").map(s => s.trim());
            const REQUIRED  = parseInt(process.env.REQUIRED_APPROVALS || "2", 10);

            if (!APPROVERS.includes(user)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `@${user} is not authorized to approve. Allowed approvers: ${APPROVERS.join(", ")}`
              });
              return;
            }

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: number, per_page: 200 });
            const approvers = new Set(
              comments.data
                .filter(c => (c.body || "").trim().startsWith("/approve-label"))
                .map(c => c.user.login)
                .filter(u => APPROVERS.includes(u))
            );
            
            approvers.add(user);

            const labelsNow = (await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number }))
              .data.map(l => l.name);

            if (labelsNow.includes("labels:approved")) {
              await github.rest.issues.removeLabel({
                owner, repo, issue_number: number, name: "labels:approved"
              }).catch(() => {});
            }

            if (approvers.size >= REQUIRED) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: number, labels: ["labels:approved"]
              });
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `labels:approved added. Approvals: ${[...approvers].map(a => "@" + a).join(", ")}`
              });

              const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });

              await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: "label_enforcement.yml",   // bu dosyanın adı
                ref: pr.data.head.ref,                   // PR'ın head branch'i
                inputs: { pr_number: String(number) }
              });
            } else {
              const pending = APPROVERS.filter(a => !approvers.has(a));
              await github.rest.issues.createComment({
                owner, repo, issue_number: number,
                body: `${approvers.size}/${REQUIRED} approvals recorded. Pending: ${pending.map(a => "@" + a).join(", ")}`
              });
            }
              